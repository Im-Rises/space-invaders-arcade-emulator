<html lang="en">
<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <link href="index.css" rel="stylesheet">
    <title>Space Invaders Emulator</title>
</head>
<body>
<div>
    <canvas class="canvas-webgl" id="canvas"></canvas>
    <button id="start" onclick="window.run()">Start
    </button>
</div>
<div>
    <div>
        <p>Rom H</p>
        <input id="input_rom_h" name="rom_h" type="file">
    </div>
    <div>
        <p>Rom G</p>
        <input id="input_rom_g" name="rom_g" type="file">
    </div>
    <div>
        <p>Rom F</p>
        <input id="input_rom_f" name="rom_f" type="file">
    </div>
    <div>
        <p>Rom E</p>
        <input id="input_rom_e" name="rom_e" type="file">
    </div>
</div>
<script type="module">
    import init, {run, test_read_uint8array} from "./pkg/space_invaders_arcade_emulator.js";

    /* Init wasm */
    async function init_wasm() {
        await init();
    }

    /* Play button */
    window.run = async function () {
        await run("canvas");
    }

    init_wasm();

    /* Test read rom */
    // document.getElementById("input_rom_h").addEventListener("change", function () {
    //     const file = this.files[0];
    //     const reader = new FileReader();
    //     reader.onload = function (e) {
    //         const arrayBuffer = e.target.result;
    //         const byteArray = new Uint8Array(arrayBuffer);
    //         window.rom_h = byteArray;
    //         console.log("Rom H loaded");
    //         // console.table(byteArray);
    //         test_read_uint8array(byteArray);
    //     };
    //     reader.readAsArrayBuffer(file);
    // });

    /* Test get all roms*/
    const inputElements = document.querySelectorAll('input[type="file"]');

    const fileData = [];

    inputElements.forEach((inputElement, index) => {
        inputElement.addEventListener('change', (event) => {
            const file = event.target.files[0];

            const reader = new FileReader();
            reader.readAsArrayBuffer(file);

            reader.onload = () => {
                const arrayBuffer = reader.result;
                const uint8Array = new Uint8Array(arrayBuffer);

                fileData[index] = uint8Array;

                if (fileData.length === inputElements.length) {
                    myFunction(fileData);
                }
            };
        });
    });

    function myFunction(uint8Arrays) {
        console.log("All roms loaded");
    }
</script>
</body>
</html>

